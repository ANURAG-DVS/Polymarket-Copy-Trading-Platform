.PHONY: help dev prod build test clean logs shell migrate

# Variables
COMPOSE_DEV = docker-compose -f docker-compose.dev.yml
COMPOSE_PROD = docker-compose -f docker-compose.prod.yml

help: ## Show this help message
	@echo 'Usage: make [target]'
	@echo ''
	@echo 'Available targets:'
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# Development
dev: ## Start development environment
	@echo "ğŸš€ Starting development environment..."
	$(COMPOSE_DEV) up -d
	@echo "âœ… Development environment started!"
	@echo "   Backend API: http://localhost:8000"
	@echo "   API Docs: http://localhost:8000/docs"
	@echo "   PGAdmin: http://localhost:5050"
	@echo "   MailHog: http://localhost:8025"
	@echo "   Redis Commander: http://localhost:8081"

dev-build: ## Build and start development environment
	@echo "ğŸ”¨ Building development environment..."
	$(COMPOSE_DEV) up -d --build

dev-stop: ## Stop development environment
	@echo "ğŸ›‘ Stopping development environment..."
	$(COMPOSE_DEV) down

dev-restart: ## Restart development environment
	@echo "ğŸ”„ Restarting development environment..."
	$(COMPOSE_DEV) restart

# Production
prod: ## Start production environment
	@echo "ğŸš€ Starting production environment..."
	$(COMPOSE_PROD) up -d
	@echo "âœ… Production environment started!"

prod-build: ## Build and start production environment
	@echo "ğŸ”¨ Building production environment..."
	$(COMPOSE_PROD) up -d --build

prod-stop: ## Stop production environment
	@echo "ğŸ›‘ Stopping production environment..."
	$(COMPOSE_PROD) down

prod-scale: ## Scale production workers
	@echo "ğŸ“ˆ Scaling production workers..."
	$(COMPOSE_PROD) up -d --scale celery_worker=5

# Build
build: ## Build all Docker images
	@echo "ğŸ”¨ Building all Docker images..."
	docker build -t polymarket-backend:latest ./backend
	docker build -t polymarket-worker:latest -f ./backend/Dockerfile.worker ./backend
	docker build -t polymarket-beat:latest -f ./backend/Dockerfile.beat ./backend
	docker build -t polymarket-telegram:latest ./telegram-bot
	@echo "âœ… All images built!"

build-backend: ## Build backend image
	@echo "ğŸ”¨ Building backend image..."
	docker build -t polymarket-backend:latest ./backend

build-worker: ## Build worker image
	@echo "ğŸ”¨ Building worker image..."
	docker build -t polymarket-worker:latest -f ./backend/Dockerfile.worker ./backend

build-telegram: ## Build telegram bot image
	@echo "ğŸ”¨ Building telegram bot image..."
	docker build -t polymarket-telegram:latest ./telegram-bot

# Testing
test: ## Run tests
	@echo "ğŸ§ª Running tests..."
	$(COMPOSE_DEV) exec backend pytest tests/ -v

test-cov: ## Run tests with coverage
	@echo "ğŸ§ª Running tests with coverage..."
	$(COMPOSE_DEV) exec backend pytest tests/ -v --cov=app --cov-report=html

# Database
migrate: ## Run database migrations
	@echo "ğŸ—„ï¸  Running database migrations..."
	$(COMPOSE_DEV) exec backend alembic upgrade head

migrate-create: ## Create new migration
	@read -p "Enter migration message: " msg; \
	$(COMPOSE_DEV) exec backend alembic revision --autogenerate -m "$$msg"

db-shell: ## Open database shell
	@echo "ğŸ—„ï¸  Opening database shell..."
	$(COMPOSE_DEV) exec postgres psql -U postgres -d polymarket_copy_dev

# Logs
logs: ## View logs for all services
	$(COMPOSE_DEV) logs -f

logs-backend: ## View backend logs
	$(COMPOSE_DEV) logs -f backend

logs-worker: ## View worker logs
	$(COMPOSE_DEV) logs -f celery_worker

logs-telegram: ## View telegram bot logs
	$(COMPOSE_DEV) logs -f telegram_bot

# Shell Access
shell-backend: ## Shell into backend container
	$(COMPOSE_DEV) exec backend /bin/bash

shell-worker: ## Shell into worker container
	$(COMPOSE_DEV) exec celery_worker /bin/bash

shell-postgres: ## Shell into postgres container
	$(COMPOSE_DEV) exec postgres /bin/bash

# Cleanup
clean: ## Remove all containers, volumes, and images
	@echo "ğŸ§¹ Cleaning up..."
	$(COMPOSE_DEV) down -v
	docker system prune -af
	@echo "âœ… Cleanup complete!"

clean-volumes: ## Remove all volumes
	@echo "ğŸ§¹ Removing volumes..."
	$(COMPOSE_DEV) down -v

# Validation
validate-env: ## Validate environment configuration
	@echo "ğŸ” Validating environment configuration..."
	python scripts/validate_env.py --env-file .env.development

validate-docker: ## Validate Docker configuration
	@echo "ğŸ” Validating Docker configuration..."
	docker-compose -f docker-compose.dev.yml config
	docker-compose -f docker-compose.prod.yml config

# Security
scan: ## Scan images for vulnerabilities
	@echo "ğŸ”’ Scanning images for vulnerabilities..."
	trivy image polymarket-backend:latest
	trivy image polymarket-worker:latest
	trivy image polymarket-telegram:latest

# Monitoring
stats: ## Show container stats
	docker stats

ps: ## Show running containers
	$(COMPOSE_DEV) ps

# Quick Commands
up: dev ## Alias for 'make dev'
down: dev-stop ## Alias for 'make dev-stop'
restart: dev-restart ## Alias for 'make dev-restart'
